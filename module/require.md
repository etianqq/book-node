#模块载入

####1.模块分类

* 原生（核心）模块
* 文件模块
    * .js。通过fs模块同步读取js文件并编译执行。
    * .node。通过C/C++进行编写的Addon。通过dlopen方法进行加载。
    * .json。读取文件，调用JSON.parse解析加载。
    
原生模块在Node.js源代码编译的时候编译进了二进制执行文件，加载的速度最快。
文件模块是动态加载的，加载速度比原生模块慢。

但是Node.js对原生模块和文件模块都进行了缓存，于是在第二次require时，是不会有重复开销的。    

####2. require方法中的文件查找策略

![](/assets/require module.jpg)

####3. 从文件加载模块

当文件模块缓存中不存在，而且不是原生模块的时候，Node.js会解析require方法传入的参数，并从文件系统中加载实际的文件。

1. 如果require绝对路径的文件，查找时不会去遍历每一个node_modules目录，其速度最快。
2. 如果require相对路径的文件：
    1. 从module path数组中取出第一个目录作为查找基准。
    2. 直接从目录中查找该文件，如果存在，则结束查找。如果不存在，则进行下一条查找。
    3. 尝试添加.js、.json、.node后缀后查找，如果存在文件，则结束查找。如果不存在，则进行下一条。
    4. 尝试将require的参数作为一个包来进行查找，读取目录下的package.json文件，取得main参数指定的文件。
    5. 尝试查找该文件，如果存在，则结束查找。如果不存在，则进行第3条查找。
    6. 如果继续失败，则取出module path数组中的下一个目录作为基准查找，循环第1至5个步骤。
    7. 如果继续失败，循环第1至6个步骤，直到module path中的最后一个值。
    8. 如果仍然失败，则抛出异常。
